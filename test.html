<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ Helios ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. é…ç½®æ£€æŸ¥</h3>
            <p>æ£€æŸ¥åŸºæœ¬é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½</p>
            <button onclick="testConfig()">æ£€æŸ¥é…ç½®</button>
            <div id="config-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. n8nè¿æ¥æµ‹è¯•</h3>
            <p>æµ‹è¯•ä¸n8n webhookçš„è¿æ¥</p>
            <input type="text" id="webhook-url" placeholder="è¾“å…¥æ‚¨çš„n8n webhook URL">
            <button onclick="testN8nConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="n8n-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
            <p>æµ‹è¯•Supabaseæ•°æ®åº“è¿æ¥ï¼ˆéœ€è¦æ‚¨æä¾›APIå¯†é’¥ï¼‰</p>
            <input type="text" id="supabase-url" placeholder="Supabase URL">
            <input type="text" id="supabase-key" placeholder="Supabase API Key">
            <button onclick="testDatabase()">æµ‹è¯•æ•°æ®åº“</button>
            <div id="db-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„æ„è¯†è½¬åŒ–æµç¨‹</p>
            <input type="text" id="test-message" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼Œå¦‚ï¼šæˆ‘æƒ³è¦å˜å¾—æ›´è‡ªä¿¡">
            <select id="test-character">
                <option value="shy_student">å†…å‘å­¦ç”Ÿ</option>
                <option value="ambitious_worker">ä¸Šè¿›é’å¹´</option>
                <option value="lonely_artist">å­¤ç‹¬è‰ºæœ¯å®¶</option>
                <option value="anxious_parent">ç„¦è™‘å®¶é•¿</option>
            </select>
            <button onclick="testFullFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. æµè§ˆå™¨å…¼å®¹æ€§</h3>
            <p>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ‰€éœ€åŠŸèƒ½</p>
            <button onclick="testBrowserCompatibility()">æ£€æŸ¥å…¼å®¹æ€§</button>
            <div id="browser-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        function testConfig() {
            try {
                const config = {
                    webhookUrl: typeof N8N_WEBHOOK_URL !== 'undefined' ? N8N_WEBHOOK_URL : 'æœªå®šä¹‰',
                    apiConfig: typeof API_CONFIG !== 'undefined' ? API_CONFIG : 'æœªå®šä¹‰',
                    appConfig: typeof APP_CONFIG !== 'undefined' ? APP_CONFIG : 'æœªå®šä¹‰'
                };
                
                let message = 'é…ç½®æ£€æŸ¥ç»“æœ:\n';
                message += `Webhook URL: ${config.webhookUrl}\n`;
                message += `APIé…ç½®: ${JSON.stringify(config.apiConfig, null, 2)}\n`;
                message += `åº”ç”¨é…ç½®: ${JSON.stringify(config.appConfig, null, 2)}`;
                
                showResult('config-result', message, 'success');
            } catch (error) {
                showResult('config-result', `é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testN8nConnection() {
            const webhookUrl = document.getElementById('webhook-url').value || N8N_WEBHOOK_URL;
            
            if (!webhookUrl || webhookUrl.includes('your-n8n-instance.com')) {
                showResult('n8n-result', 'è¯·å…ˆé…ç½®æ­£ç¡®çš„n8n webhook URL', 'error');
                return;
            }

            try {
                showResult('n8n-result', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chatInput: 'æµ‹è¯•è¿æ¥',
                        character_id: 'shy_student',
                        sessionId: 'test_session'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('n8n-result', `è¿æ¥æˆåŠŸ!\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('n8n-result', `è¿æ¥å¤±è´¥: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('n8n-result', `è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            const supabaseUrl = document.getElementById('supabase-url').value;
            const supabaseKey = document.getElementById('supabase-key').value;

            if (!supabaseUrl || !supabaseKey) {
                showResult('db-result', 'è¯·è¾“å…¥Supabase URLå’ŒAPIå¯†é’¥', 'error');
                return;
            }

            try {
                showResult('db-result', 'æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
                
                const response = await fetch(`${supabaseUrl}/rest/v1/characters?select=*`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('db-result', `æ•°æ®åº“è¿æ¥æˆåŠŸ!\nè§’è‰²æ•°é‡: ${data.length}\næ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('db-result', `æ•°æ®åº“è¿æ¥å¤±è´¥: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('db-result', `æ•°æ®åº“é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            const message = document.getElementById('test-message').value;
            const character = document.getElementById('test-character').value;

            if (!message) {
                showResult('flow-result', 'è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'error');
                return;
            }

            try {
                showResult('flow-result', 'æ­£åœ¨æµ‹è¯•å®Œæ•´æµç¨‹...', 'info');
                
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chatInput: message,
                        character_id: character,
                        sessionId: 'test_session_' + Date.now()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('flow-result', `å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ!\nè¾“å…¥: ${message}\nè§’è‰²: ${character}\nè¾“å‡º: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('flow-result', `æµç¨‹æµ‹è¯•å¤±è´¥: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('flow-result', `æµç¨‹æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testBrowserCompatibility() {
            const tests = {
                'Fetch API': typeof fetch !== 'undefined',
                'Local Storage': typeof localStorage !== 'undefined',
                'JSONæ”¯æŒ': typeof JSON !== 'undefined',
                'ES6ç®­å¤´å‡½æ•°': (() => true)(),
                'Promiseæ”¯æŒ': typeof Promise !== 'undefined',
                'async/awaitæ”¯æŒ': (async () => true)() instanceof Promise
            };

            let message = 'æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥:\n';
            let allPassed = true;

            for (const [test, result] of Object.entries(tests)) {
                message += `${test}: ${result ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}\n`;
                if (!result) allPassed = false;
            }

            message += `\næ€»ä½“è¯„ä¼°: ${allPassed ? 'âœ… å®Œå…¨å…¼å®¹' : 'âŒ å­˜åœ¨å…¼å®¹æ€§é—®é¢˜'}`;
            
            showResult('browser-result', message, allPassed ? 'success' : 'error');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
        window.addEventListener('load', function() {
            testConfig();
            testBrowserCompatibility();
        });
    </script>
</body>
</html>
