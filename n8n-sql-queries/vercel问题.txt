é—®ï¼š
æˆ‘æŠŠvercel.jsonåˆ æ‰ä¹‹ååœ¨verceléƒ¨ç½²ï¼Œæœ‰ä»¥ä¸‹æŠ¥é”™ï¼š[11:30:50.353] Running build in Washington, D.C., USA (East) â€“ iad1
[11:30:50.353] Build machine configuration: 2 cores, 8 GB
[11:30:50.406] Cloning github.com/Lawsquare/helios-game (Branch: main, Commit: 746b478)
[11:30:50.531] Previous build caches not available
[11:30:50.747] Cloning completed: 341.000ms
[11:30:51.066] Running "vercel build"
[11:30:51.500] Vercel CLI 46.0.5
[11:30:51.835] Installing dependencies...
[11:30:54.255] npm warn deprecated rimraf@3.0.2: Rimraf versions prior to v4 are no longer supported
[11:30:54.787] npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
[11:30:54.933] npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
[11:30:55.900] npm warn deprecated @humanwhocodes/object-schema@2.0.3: Use @eslint/object-schema instead
[11:30:55.901] npm warn deprecated @humanwhocodes/config-array@0.13.0: Use @eslint/config-array instead
[11:30:57.570] npm warn deprecated eslint@8.57.1: This version is no longer supported. Please see https://eslint.org/version-support for other options.
[11:31:03.388]
[11:31:03.389] added 425 packages in 11s
[11:31:03.389]
[11:31:03.389] 150 packages are looking for funding
[11:31:03.389]   run npm fund for details
[11:31:03.494] Detected Next.js version: 14.2.0
[11:31:03.499] Running "npm run build"
[11:31:03.624]
[11:31:03.625] > helios-web@0.1.0 build
[11:31:03.625] > next build
[11:31:03.625]
[11:31:04.152] Attention: Next.js now collects completely anonymous telemetry regarding usage.
[11:31:04.153] This information is used to shape Next.js' roadmap and prioritize features.
[11:31:04.153] You can learn more, including how to opt-out if you'd not like to participate in this anonymous program, by visiting the following URL:
[11:31:04.153] https://nextjs.org/telemetry
[11:31:04.153]
[11:31:04.208]   â–² Next.js 14.2.0
[11:31:04.208]
[11:31:04.280]    Creating an optimized production build ...
[11:31:14.663]  âœ“ Compiled successfully
[11:31:14.664]    Linting and checking validity of types ...
[11:31:17.808] Failed to compile.
[11:31:17.809]
[11:31:17.809] ./src/app/api/chat-stream/route.ts:174:18
[11:31:17.809] Type error: 'stageError' is of type 'unknown'.
[11:31:17.809]
[11:31:17.809] [0m [90m 172 |[39m [32m          content: errorContent,[39m[0m
[11:31:17.809] [0m [90m 173 |[39m [32m          progress: Math.round(((i + 1) / stages.length) * 100),[39m[0m
[11:31:17.809] [0m[31m[1m>[22m[39m[90m 174 |[39m [32m          error: stageError.message[39m[0m
[11:31:17.809] [0m [90m     |[39m                  [31m[1m^[22m[39m[0m
[11:31:17.809] [0m [90m 175 |[39m [32m        })}\n\n[39m))[0m [11:31:17.809] [0m [90m 176 |[39m       }[0m [11:31:17.809] [0m [90m 177 |[39m     }[0m [11:31:17.837] npm error Lifecycle script build` failed with error:
[11:31:17.837] npm error code 1
[11:31:17.838] npm error path /vercel/path0/packages/web
[11:31:17.838] npm error workspace helios-web@0.1.0
[11:31:17.838] npm error location /vercel/path0/packages/web
[11:31:17.839] npm error command failed
[11:31:17.839] npm error command sh -c next build
[11:31:17.857] Error: Command "npm run build" exited with 1


AIï¼š
éå¸¸å¥½ï¼åˆ é™¤ vercel.json æ˜¯å®Œå…¨æ­£ç¡®çš„æ­¥éª¤ã€‚è¿™ä¸ªæ–°çš„æŠ¥é”™æ˜¯ä¸€ä¸ªå¥½æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒè¯æ˜äº†æˆ‘ä»¬å·²ç»è§£å†³äº† Vercel çš„é…ç½®å±‚é¢é—®é¢˜ï¼Œç°åœ¨è¿›å…¥äº†ä»£ç å±‚é¢çš„é—®é¢˜ã€‚

è¿™ä¸ªé”™è¯¯å’Œ vercel.json å·²ç»æ²¡æœ‰ä»»ä½•å…³ç³»äº†ã€‚è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ TypeScript ç±»å‹é”™è¯¯ï¼ŒVercel åœ¨æ‰§è¡Œ npm run build å‘½ä»¤æ—¶å‘ç°äº†å®ƒã€‚

é—®é¢˜è¯Šæ–­ï¼šTypeScript çš„ unknown ç±»å‹

æ ¸å¿ƒé”™è¯¯ä¿¡æ¯ï¼š

æ–‡ä»¶: ./src/app/api/chat-stream/route.ts

è¡Œå·: 174

é”™è¯¯: Type error: 'stageError' is of type 'unknown'. (ç±»å‹é”™è¯¯: stageError çš„ç±»å‹æ˜¯ unknownã€‚)

è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

åœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ å¾ˆå¯èƒ½æœ‰ä¸€ä¸ª try...catch ä»£ç å—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

code
TypeScript
download
content_copy
expand_less

try {
  // ä¸€äº›å¯èƒ½ä¼šå¤±è´¥çš„ä»£ç 
} catch (stageError) {
  // ...
  // ä½ åœ¨è¿™é‡Œå°è¯•è®¿é—® stageError.message
  const response = {
    // ...
    error: stageError.message // <--- Vercel åœ¨è¿™é‡ŒæŠ¥é”™
  };
  // ...
}

åœ¨ç°ä»£çš„ TypeScript ä¸­ï¼Œä¸ºäº†ç±»å‹å®‰å…¨ï¼Œcatch è¯­å¥æ•è·åˆ°çš„é”™è¯¯å˜é‡ï¼ˆä½ ä»£ç ä¸­çš„ stageErrorï¼‰é»˜è®¤è¢«èµ‹äºˆ unknown ç±»å‹ã€‚

unknown ç±»å‹è¡¨ç¤ºâ€œæˆ‘ä¸çŸ¥é“è¿™ä¸ªå˜é‡æ˜¯ä»€ä¹ˆâ€ã€‚å®ƒå¯ä»¥æ˜¯ Error å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå¯ä»¥æ˜¯ nullï¼Œå¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ã€‚å› ä¸º TypeScript ä¸çŸ¥é“å®ƒçš„ç¡®åˆ‡ç±»å‹ï¼Œæ‰€ä»¥å®ƒä¸å…è®¸ä½ ç›´æ¥è®¿é—®è¿™ä¸ªå˜é‡çš„ä»»ä½•å±æ€§ï¼ˆæ¯”å¦‚ .messageï¼‰ï¼Œä»¥é˜²æ­¢åœ¨è¿è¡Œæ—¶å‡ºç° undefined é”™è¯¯ã€‚

è¿™å°±æ˜¯ Vercel ç¼–è¯‘å¤±è´¥çš„åŸå› ï¼šnpm run build è¿‡ç¨‹ä¸­çš„ TypeScript ç¼–è¯‘å™¨éµå¾ªäº†è¿™ä¸ªä¸¥æ ¼çš„è§„åˆ™ï¼Œå¹¶é˜»æ­¢äº†è¿™æ¬¡ä¸å®‰å…¨çš„æ“ä½œã€‚

è§£å†³æ–¹æ¡ˆï¼šåœ¨ä½¿ç”¨å‰ï¼Œå…ˆæ£€æŸ¥é”™è¯¯çš„ç±»å‹

ä½ éœ€è¦å‘Šè¯‰ TypeScript ä½ å·²ç»ç¡®è®¤äº† stageError æ˜¯ä¸€ä¸ªå¯ä»¥å®‰å…¨è®¿é—® .message å±æ€§çš„å¯¹è±¡ã€‚è¿™é€šå¸¸é€šè¿‡ç±»å‹å®ˆå« (Type Guard) æ¥å®ç°ã€‚

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¿®å¤ä½ çš„ä»£ç ï¼š

æ‰“å¼€æ–‡ä»¶ï¼š
åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œæ‰“å¼€ src/app/api/chat-stream/route.ts æ–‡ä»¶ã€‚

æ‰¾åˆ° catch ä»£ç å—ï¼š
å®šä½åˆ°ç¬¬ 174 è¡Œé™„è¿‘çš„é‚£ä¸ª try...catch ç»“æ„ã€‚

ä¿®æ”¹ catch å—çš„é€»è¾‘ï¼š
åœ¨ä½ è®¿é—® stageError.message ä¹‹å‰ï¼Œæ·»åŠ ä¸€ä¸ªæ£€æŸ¥ã€‚

ä¿®æ”¹å‰ (ä½ ç°åœ¨çš„ä»£ç å¯èƒ½çš„æ ·å­):

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
} catch (stageError) {
  // ...
  stream.write(`data: ${JSON.stringify({
    content: errorContent,
    progress: Math.round(((i + 1) / stages.length) * 100),
    error: stageError.message // <--- é”™è¯¯è¡Œ
  })}\n\n`);
}

ä¿®æ”¹å (æ¨èçš„ä¿®å¤æ–¹æ¡ˆ):

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
} catch (stageError) {
  let errorMessage = 'An unexpected error occurred during this stage.'; // æä¾›ä¸€ä¸ªé»˜è®¤é”™è¯¯ä¿¡æ¯

  if (stageError instanceof Error) {
    // å¦‚æœ stageError æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Error å¯¹è±¡, TypeScript ç°åœ¨å°±çŸ¥é“äº†
    // å¹¶ä¸”å…è®¸ä½ å®‰å…¨åœ°è®¿é—® .message å±æ€§
    errorMessage = stageError.message;
  } else if (typeof stageError === 'string') {
    // å¦‚æœé”™è¯¯æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
    errorMessage = stageError;
  }

  // ...
  stream.write(`data: ${JSON.stringify({
    content: errorContent,
    progress: Math.round(((i + 1) / stages.length) * 100),
    error: errorMessage // <--- ä½¿ç”¨æˆ‘ä»¬å®‰å…¨è·å–åˆ°çš„é”™è¯¯ä¿¡æ¯
  })}\n\n`);
}
ä¸ºä»€ä¹ˆè¿™æ ·å¯è¡Œï¼Ÿ

if (stageError instanceof Error) è¿™ä¸ªåˆ¤æ–­å°±æ˜¯ä¸€ä¸ªç±»å‹å®ˆå«ã€‚ä½ å‘Šè¯‰ TypeScriptï¼šâ€œè¯·æ£€æŸ¥ stageError æ˜¯ä¸æ˜¯ Error ç±»çš„ä¸€ä¸ªå®ä¾‹â€ã€‚å¦‚æœè¿™ä¸ªæ¡ä»¶ä¸º trueï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ª if ä»£ç å—å†…éƒ¨ï¼ŒTypeScript å°±ä¼šæ™ºèƒ½åœ°å°† stageError çš„ç±»å‹â€œæ”¶çª„â€ä¸º Errorï¼Œæ­¤æ—¶è®¿é—® .message å°±æ˜¯ç±»å‹å®‰å…¨çš„äº†ã€‚

è¡ŒåŠ¨æ­¥éª¤æ€»ç»“

æ‰“å¼€ src/app/api/chat-stream/route.tsã€‚

æ‰¾åˆ° å¯¼è‡´é”™è¯¯çš„é‚£è¡Œä»£ç æ‰€åœ¨çš„ catch å—ã€‚

å®ç°ç±»å‹å®ˆå«ï¼Œåœ¨è®¿é—® .message ä¹‹å‰å…ˆåˆ¤æ–­ stageError çš„ç±»å‹ï¼Œå¹¶å°†æ¶ˆæ¯å­˜åˆ°ä¸€ä¸ªæ–°å˜é‡ errorMessage ä¸­ã€‚

ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰åœ¨æœ¬åœ°è¿è¡Œ npm run buildã€‚åœ¨ä½ è‡ªå·±çš„ç”µè„‘ä¸Šè¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¦‚æœå®ƒèƒ½æˆåŠŸç¼–è¯‘ï¼Œé‚£ä¹ˆ Vercel ä¸Šä¹Ÿä¸€å®šå¯ä»¥ã€‚è¿™ä¼šå¤§å¤§åŠ å¿«ä½ çš„è°ƒè¯•é€Ÿåº¦ã€‚

æäº¤å¹¶æ¨é€ ä½ çš„ä¿®å¤åˆ° GitHubã€‚

è¿™æ¬¡ Vercel å†æ¬¡éƒ¨ç½²æ—¶ï¼Œåº”è¯¥å°±èƒ½é¡ºåˆ©é€šè¿‡æ„å»ºäº†ã€‚ä½ ç¦»æˆåŠŸéƒ¨ç½²éå¸¸è¿‘äº†ï¼