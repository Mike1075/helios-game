-- ========================================
-- 获取用户当前激活的角色
-- ========================================
-- 
-- 用途: 替换 n8n 工作流中的"获取当前角色"节点
-- 节点类型: n8n-nodes-base.postgres
-- 操作: Execute Query
-- 
-- 输入变量:
--   - user_id: 从 webhook 的 body.user_id 获取
-- 
-- 输出字段:
--   - character_id: 角色ID，供后续查询使用
-- 
-- ========================================

SELECT uc.character_id 
FROM user_characters uc 
WHERE uc.user_id = '{{ $json.body.user_id }}'::UUID 
AND uc.is_active = true;

-- ========================================
-- 使用说明
-- ========================================
-- 
-- 1. 在 n8n 中创建 Postgres 节点
-- 2. 选择操作: "Execute Query"
-- 3. 复制上面的 SQL 查询到查询框
-- 4. 配置数据库连接: 使用现有的 Supabase 凭据
-- 5. 节点名称建议: "获取当前角色"
-- 
-- 预期返回结果示例:
-- {
--   "character_id": "shy_student"
-- }
-- 
-- 错误处理:
-- - 如果用户不存在或没有激活角色，查询将返回空结果
-- - 建议在后续节点中添加空值检查
-- 
-- ========================================
