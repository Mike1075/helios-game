-- ========================================
-- 所有 n8n SQL 查询合集
-- ========================================
-- 
-- 此文件包含所有用于替换 Supabase Tool 节点的 SQL 查询
-- 按照 n8n 工作流的执行顺序排列
-- 
-- ========================================

-- ========================================
-- 1. 获取用户当前激活的角色
-- 节点名称: "获取当前角色"
-- ========================================

SELECT uc.character_id 
FROM user_characters uc 
WHERE uc.user_id = '{{ $json.body.user_id }}'::UUID 
AND uc.is_active = true;

-- ========================================
-- 2. 获取角色的信念系统数据
-- 节点名称: "获取信念"
-- 依赖: 获取当前角色
-- ========================================

SELECT 
    id,
    content,
    embedding,
    character_id,
    created_at
FROM belief_systems 
WHERE character_id = '{{ $("获取当前角色").item.json.character_id }}';

-- ========================================
-- 3. 获取角色的内驱力数据
-- 节点名称: "获取内驱力"
-- 依赖: 获取当前角色
-- ========================================

SELECT 
    id,
    content,
    embedding,
    character_id,
    created_at
FROM inner_drives 
WHERE character_id = '{{ $("获取当前角色").item.json.character_id }}';

-- ========================================
-- 4. 获取集体潜意识数据
-- 节点名称: "获取集体潜意识"
-- 依赖: 无 (独立查询)
-- ========================================

SELECT 
    id,
    content,
    embedding,
    created_at
FROM collective_unconscious
ORDER BY created_at DESC;

-- ========================================
-- 5. 获取角色的外我特征数据 (行为相关)
-- 节点名称: "获取外我(行为)"
-- 依赖: 获取当前角色
-- ========================================

SELECT 
    id,
    content,
    embedding,
    character_id,
    created_at
FROM outer_self_traits 
WHERE character_id = '{{ $("获取当前角色").item.json.character_id }}';

-- ========================================
-- 6. 获取角色的外我特征数据 (反应相关)
-- 节点名称: "获取外我(反应)"
-- 依赖: 获取当前角色
-- ========================================

SELECT 
    id,
    content,
    embedding,
    character_id,
    created_at
FROM outer_self_traits 
WHERE character_id = '{{ $("获取当前角色").item.json.character_id }}';

-- ========================================
-- 数据流向图
-- ========================================
-- 
-- Webhook (user_id)
--     ↓
-- 获取当前角色 (character_id)
--     ↓
-- ┌─────────────────┬─────────────────┬─────────────────┐
-- ↓                 ↓                 ↓                 ↓
-- 获取信念          获取内驱力        获取外我(行为)    获取外我(反应)
--                                     
-- 获取集体潜意识 (独立)
-- 
-- ========================================
-- 替换步骤总结
-- ========================================
-- 
-- 1. 删除所有 n8n-nodes-base.supabaseTool 节点
-- 2. 为每个查询创建新的 Postgres 节点
-- 3. 复制对应的 SQL 查询到节点中
-- 4. 配置数据库连接 (使用现有 Supabase 凭据)
-- 5. 重新连接节点之间的数据流
-- 6. 测试工作流确保正常运行
-- 
-- ========================================
